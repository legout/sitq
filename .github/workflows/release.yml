name: Release and Version Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      changes:
        description: 'List of changes for changelog'
        required: false
        type: string

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Configure Git
      run: |
        git config --global user.name "sitq-bot"
        git config --global user.email "bot@sitq.dev"
    
    - name: Bump version
      run: |
        python scripts/version.py prepare --type ${{ github.event.inputs.version_type }} --changes ${{ github.event.inputs.changes }}
    
    - name: Commit changes
      run: |
        git add .
        git commit -m "chore: bump version for ${{ github.event.inputs.version_type }} release"
        git push origin develop
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: version bump for ${{ github.event.inputs.version_type }} release"
        title: "Version Bump for ${{ github.event.inputs.version_type }} Release"
        body: |
          Automated version bump for ${{ github.event.inputs.version_type }} release.
          
          Changes:
          ${{ github.event.inputs.changes }}
          
          Please review and merge to trigger release.
        branch: version-bump-${{ github.event.inputs.version_type }}
        base: develop

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Extract version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Release version: $VERSION"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        python -m pytest --cov=sitq --cov-report=xml
        python -m flake8 src/sitq tests
        python -m mypy src/sitq
    
    - name: Build package
      run: |
        python -m build
    
    - name: Generate distribution artifacts
      run: |
        mkdir dist-artifacts
        cp dist/* dist-artifacts/
        
        # Generate checksums
        cd dist-artifacts
        sha256sum * > SHA256SUMS
        cd ..
    
    - name: Build documentation
      run: |
        mkdocs build --site-dir site
        
        # Copy documentation to dist
        cp -r site dist-artifacts/docs
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-artifacts
        path: dist-artifacts/
        retention-days: 30
    
    - name: Check if pre-release
      id: prerelease
      run: |
        if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "prerelease=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist-artifacts/*
        draft: false
        prerelease: ${{ steps.prerelease.outputs.prerelease }}
        generate_release_notes: true
        name: sitq ${{ env.VERSION }}
        tag_name: v${{ env.VERSION }}
        body: |
          ## sitq ${{ env.VERSION }}
          
          üöÄ **Release Highlights**
          
          üì¶ **Installation**
          ```bash
          pip install sitq==${{ env.VERSION }}
          ```
          
          üìö **Documentation**
          - [User Guide](https://sitq.readthedocs.io/en/${{ env.VERSION }}/)
          - [API Reference](https://sitq.readthedocs.io/en/${{ env.VERSION }}/api-reference/)
          - [Changelog](https://sitq.readthedocs.io/en/${{ env.VERSION }}/user-guide/changelog/)
          
          üîß **Quick Start**
          ```python
          import sitq
          
          queue = sitq.TaskQueue()
          worker = sitq.Worker(queue)
          
          task = sitq.Task(function=lambda x: x * 2, args=[21])
          task_id = queue.enqueue(task)
          result = worker.process_task(task_id)
          print(result.value)  # 42
          ```
          
          ---
          
          üêõ **Bug Reports**: [GitHub Issues](https://github.com/username/sitq/issues)
          üí¨ **Discussions**: [GitHub Discussions](https://github.com/username/sitq/discussions)
          üìñ **Documentation**: [sitq.readthedocs.io](https://sitq.readthedocs.io/)
    
    - name: Publish to PyPI
      if: steps.prerelease.outputs.prerelease == 'false'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*
    
    - name: Publish to Test PyPI
      if: steps.prerelease.outputs.prerelease == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*
    
    - name: Update documentation version
      run: |
        # Update version in documentation
        python scripts/version.py current
        
        # Deploy to GitHub Pages
        mkdocs gh-deploy --force --no-require-clean
    
    - name: Notify release
      run: |
        echo "‚úÖ Release ${{ env.VERSION }} completed successfully!"
        echo "üì¶ Available on PyPI: https://pypi.org/project/sitq/"
        echo "üìö Documentation: https://sitq.readthedocs.io/en/${{ env.VERSION }}/"
        echo "üè∑Ô∏è GitHub Release: https://github.com/username/sitq/releases/tag/v${{ env.VERSION }}"

  post-release:
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Extract version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    
    - name: Update development version
      run: |
        # Bump to next development version
        python scripts/version.py bump --type patch
        
        # Add dev suffix
        CURRENT_VERSION=$(python scripts/version.py current)
        DEV_VERSION="${CURRENT_VERSION}-dev"
        
        python scripts/version.py prepare --type patch --changes "Development version bump"
        
        # Update to dev version
        sed -i "s/__version__ = \".*\"/__version__ = \"$DEV_VERSION\"/" src/sitq/__init__.py
        
        git add .
        git commit -m "chore: bump development version to $DEV_VERSION"
        git push origin main
    
    - name: Create next milestone
      uses: actions/github-script@v6
      with:
        script: |
          const version = "${{ env.VERSION }}";
          const [major, minor, patch] = version.split('.').map(Number);
          const nextPatch = patch + 1;
          const nextVersion = `${major}.${minor}.${nextPatch}`;
          
          github.rest.issues.createMilestone({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `sitq ${nextVersion}`,
            state: 'open',
            description: `Milestone for sitq ${nextVersion} release`
          });
    
    - name: Notify community
      run: |
        echo "üéâ sitq ${{ env.VERSION }} has been released!"
        echo ""
        echo "What's new:"
        echo "- Check the [changelog](https://sitq.readthedocs.io/en/${{ env.VERSION }}/user-guide/changelog/)"
        echo "- Browse the [documentation](https://sitq.readthedocs.io/en/${{ env.VERSION }}/)"
        echo "- Install with: pip install sitq==${{ env.VERSION }}"
        echo ""
        echo "Thank you to all contributors! üôè"